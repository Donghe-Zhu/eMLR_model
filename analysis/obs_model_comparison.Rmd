---
title: "Observation and model variables comparison"
author: "Donghe Zhu and Dr Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```


```{r library, message = FALSE, warning = FALSE}
library(tidyverse)
```

```{r read_mask_files, include = FALSE}

basinmask <- read_csv(
  here::here(
    "data/World_Ocean_Atlas_2018/_summarized_files",
    "basin_mask_WOA18_AIP.csv"
  )
)

landmask <-  read_csv(
  here::here(
    "data/World_Ocean_Atlas_2018/_summarized_files",
    "land_mask_WOA18.csv"
  )
)

```

```{r ggplot_theme, include = FALSE}
# ggplot theme for all plots
theme_set(theme_bw())
```


# Read joined GLODAP + model data

```{r read_GLODAP_with_model_subset_data}

# set path to model analysis/subsetting output files
path_model_analysis <-
  "/nfs/kryo/work/loher/CESM_output/RECCAP2/analysis/"

# read file for GLODAP observations + subsetted model variables
GLODAP_model <- 
  read_csv(paste(
    paste(path_model_analysis, "glodapv2_2020_synthetic_data/", sep = ""),
    "GLODAP_with_model_subset.csv",
    sep = ""
  ))

```

# Apply basin mask

```{r apply_basin_mask_to_GLODAP_model_data}

GLODAP_model <- inner_join(GLODAP_model, basinmask)

```



# Observation and model data comparison

```{r all_years_comparison}

# for loop across variables
obs_var <-
  c("tco2",
    "talk",
    "oxygen",
    "nitrate",
    "phosphate",
    "silicate",
    "sal",
    "tem")
model_var <-
  c(
    "DIC_model",
    "ALK_model",
    "O2_model",
    "NO3_model",
    "PO4_model",
    "SiO3_model",
    "SALT_model",
    "TEMP_model"
  )

# too many figures, here instead of length(obs_var), just use the first two.
for (i in 1:8) {
  # Uncomment line below for manual testing
  # i <- 2
  
  # select correlated observation and model variable
  variable_all <- GLODAP_model %>%
    select(year,
           month,
           lat,
           lon,
           depth,
           !!sym(obs_var[i]),
           !!sym(model_var[i])) %>%
    drop_na() %>%
    mutate(
      season = case_when(
        month %in% c(3, 4, 5) ~ "Spring",
        month %in% c(6, 7, 8) ~ "Summer",
        month %in% c(9, 10, 11) ~ "Autumn",
        month %in% c(12, 1, 2) ~ "Winter"
      )
    )
  
  # calculate equal axis limits and binwidth
  axis_lims <- variable_all %>%
    summarise(
      max_value = max(c(
        max(!!sym(obs_var[i])),
        max(!!sym(model_var[i])))),
      min_value = min(c(
        min(!!sym(obs_var[i])),
        min(!!sym(model_var[i]))))
      )
  
  binwidth_value <- (axis_lims$max_value - axis_lims$min_value) / 30
  axis_lims <- c(axis_lims$min_value, axis_lims$max_value)

  
  # obs-model plot (season)
  print(
    ggplot(variable_all, aes(
      x = !!sym(obs_var[i]),
      y = !!sym(model_var[i])
    )) +
      geom_bin2d(binwidth = binwidth_value) +
      labs(
        title = "Observation (x) vs Model (y)",
        subtitle = "Seasonal comparison"
      ) +
      scale_fill_viridis_c(trans = "log") +
      geom_abline(slope = 1,
                  col = 'red') +
      coord_equal(xlim = axis_lims,
                  ylim = axis_lims) +
      facet_wrap( ~ season)
  )
  
  # obs-model plot (year)
  print(
    ggplot(variable_all, aes(
      x = !!sym(obs_var[i]),
      y = !!sym(model_var[i])
    )) +
      geom_bin2d(binwidth = binwidth_value) +
      labs(
        title = "Observation (x) vs Model (y)",
        subtitle = "All years"
      ) +
      scale_fill_viridis_c(trans = "log") +
      geom_abline(slope = 1, col = 'red') +
      coord_equal(xlim = axis_lims,
                  ylim = axis_lims)
  )
  
  
  # Calculate annual mean offset
  variable_year <- GLODAP_model %>%
    select(year,!!sym(obs_var[i]),!!sym(model_var[i])) %>% 
    drop_na() %>%
    mutate(offset = !!sym(model_var[i]) -!!sym(obs_var[i])) %>%
    group_by(year) %>%
    summarise(offset = mean(offset)) %>%
    ungroup()
  
  # plot annual mean offset
  print(
    variable_year %>%
      ggplot(aes(year, offset)) +
      geom_point() +
      geom_line() +
      labs(title = "Annual mean offset",
           subtitle = paste(sym(model_var[i]), "-", sym(obs_var[i])))
  )
  
  # spatial distribution of the model-observations offset for 4 depth intervals
  intervals <- c(0, 150, 500, 2000, 8000)
  for (j in 1:4) {
    variable_annual <- GLODAP_model %>%
      select(lat, lon, depth, !!sym(obs_var[i]), !!sym(model_var[i])) %>%
      filter(depth %in% (intervals[j]:intervals[j + 1])) %>%
      drop_na() %>%
      mutate(offset = !!sym(model_var[i]) -!!sym(obs_var[i])) %>%
      group_by(lat, lon) %>%
      summarise(offset = mean(offset)) %>%
      ungroup()
    
    # plot mean spatial distribution
    print(
      ggplot() +
        geom_raster(data = variable_annual, aes(lon, lat, fill = offset)) +
        scale_fill_viridis_c(name = "offset", trans = "log") +
        coord_quickmap(expand = 0) +
        labs(
          title = paste(model_var[i], "vs", obs_var[i], "mean offset spatial distribution"),
          subtitle = paste("Depth intervals:", intervals[j], "-", intervals[j +
                                                                              1]),
          x = "Longitude",
          y = "Latitude"
        ) +
        geom_raster(data = landmask,
                    aes(lon, lat), fill = "grey80")
    )
  }
}

```

# Model diagnostics

A set of model summary statistics was calculated for each relevant variable and year.

```{r read_model_summary_stats}

# write file for model summary statistics
model_stats <-
  read_csv(paste(
    paste(path_model_analysis, "diagnostics/", sep = ""),
    "GIAF_JRA_2020_summary_stats.csv"
  ))

```

```{r pivot_model_summary_stats}

model_stats_wide <- model_stats %>% 
  pivot_longer(Min.:Max.,
               names_to = "estimate",
               values_to = "value")

```

```{r GIAF_JRA_model_stats, fig.asp=7}

model_stats_wide %>% 
  ggplot(aes(year, value)) +
  geom_path() +
  geom_point() +
  facet_wrap(~ interaction(estimate, variable),
             ncol = 1,
             scales = "free_y")

```




