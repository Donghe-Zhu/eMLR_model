---
title: "Observation and model variables comparison"
author: "Donghe Zhu and Dr Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```


```{r library, message = FALSE, warning = FALSE}
library(tidyverse)
```

```{r ggplot_theme, include = FALSE}
# ggplot theme for all plots
theme_set(theme_bw())
```


# Read joined GLODAP + model data

```{r read_GLODAP_with_model_subset_data}

GLODAP_model <- read_csv(here::here("data/GLODAPv2_2020",
                       "GLODAP_with_model_subset.csv"))

```


# Observation and model data comparison

```{r all_years_comparison}

# for loop across variables
obs_var <-
  c("tco2",
    "talk",
    "oxygen",
    "nitrate",
    "phosphate",
    "silicate",
    "sal",
    "tem")
model_var <-
  c(
    "DIC_model",
    "ALK_model",
    "O2_model",
    "NO3_model",
    "PO4_model",
    "SiO3_model",
    "SALT_model",
    "TEMP_model"
  )

# too many figures, here instead of length(obs_var), just use the first two.
for (i in 1:8) {
  # Uncomment line below for manual testing
  # i <- 1
  
  # select correlated observation and model variable
  variable_all <- GLODAP_model %>%
    select(year,
           month,
           lat,
           lon,
           depth,
           !!sym(obs_var[i]),
           !!sym(model_var[i])) %>%
    drop_na() %>%
    mutate(
      season = case_when(
        month %in% c(3, 4, 5) ~ "Spring",
        month %in% c(6, 7, 8) ~ "Summer",
        month %in% c(9, 10, 11) ~ "Autumn",
        month %in% c(12, 1, 2) ~ "Winter"
      )
    )
  
  # calculate equal axis limits and binwidth
  axis_lims <- variable_all %>%
    summarise(
      max_value = max(c(
        max(!!sym(obs_var[i])),
        max(!!sym(model_var[i])))),
      min_value = min(c(
        min(!!sym(obs_var[i])),
        min(!!sym(model_var[i]))))
      )
  
  binwidth_value <- (axis_lims$max_value - axis_lims$min_value) / 30
  axis_lims <- c(axis_lims$min_value, axis_lims$max_value)

  
  # obs-model plot (season)
  print(
    ggplot(variable_all, aes(
      x = !!sym(obs_var[i]),
      y = !!sym(model_var[i])
    )) +
      geom_bin2d(binwidth = binwidth_value) +
      labs(
        title = "Observation (x) vs Model (y)",
        subtitle = "Seasonal comparison"
      ) +
      scale_fill_viridis_c() +
      geom_abline(slope = 1,
                  col = 'red') +
      coord_equal(xlim = axis_lims,
                  ylim = axis_lims) +
      facet_wrap( ~ season)
  )
  
  # obs-model plot (year)
  print(
    ggplot(variable_all, aes(
      x = !!sym(obs_var[i]),
      y = !!sym(model_var[i])
    )) +
      geom_bin2d(binwidth = binwidth_value) +
      labs(
        title = "Observation (x) vs Model (y)",
        subtitle = "All years"
      ) +
      scale_fill_viridis_c() +
      geom_abline(slope = 1, col = 'red') +
      coord_equal(xlim = axis_lims,
                  ylim = axis_lims)
  )
  
  
  # Calculate annual mean offset
  variable_year <- GLODAP_model %>%
    select(year,!!sym(obs_var[i]),!!sym(model_var[i])) %>%
    drop_na() %>%
    mutate(offset = !!sym(model_var[i]) -!!sym(obs_var[i])) %>%
    group_by(year) %>%
    summarise(offset = mean(offset)) %>%
    ungroup()
  
  # plot annual mean offset
  print(
    variable_year %>%
      ggplot(aes(year, offset)) +
      geom_point() +
      geom_line() +
      labs(title = "Annual mean offset",
           subtitle = paste(sym(model_var[i]), "-", sym(obs_var[i])))
  )
      
}

```

# Model diagnostics

A set of model summary statistics was calculated for each relevant variable and year.

```{r read_model_summary_stats}
model_stats <- read_csv(here::here("data/model/summary_stats",
                       "GIAF_JRA_2020_summary_stats.csv"))
```

```{r pivot_model_summary_stats}

model_stats_wide <- model_stats %>% 
  pivot_longer(Min.:Max.,
               names_to = "estimate",
               values_to = "value")

```

```{r GIAF_JRA_model_stats, fig.asp=7}

model_stats_wide %>% 
  ggplot(aes(year, value)) +
  geom_path() +
  geom_point() +
  facet_wrap(~ interaction(estimate, variable),
             ncol = 1,
             scales = "free_y")

```




